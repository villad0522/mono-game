<!DOCTYPE html>
<html lang="ja">

    <head>
        <meta charset="utf-8">
        <title>TimeHunter</title>
        <script src="https://mono-socket.link"></script>
    </head>

    <body>
        <script>
            // 右クリックしたときにメニューを表示させない
            document.oncontextmenu = (e) => { e.preventDefault(); }

            monoSocket.init('index.html', 'cd02a276-44d2-44aa-b04b-7ddc26be5dba');

            const roomNumber = monoSocket.getRoomNumber();
            const myPlayerId = monoSocket.getPlayerId();

            const mapMatrix = [
                [
                    // ステージ１
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1],
                    [1, 2, 0, 0, 0, 0, 0, 4, 1, 3, 1, 1, 1, 0, 3, 1],
                    [1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1],
                    [1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1],
                    [1, 1, 0, 4, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                ],
            ];

            var groundImages = [];
            var playerOriginalImages = [];
            var playerImages = [];

            function preload() {
                groundImages = [        //画像の読み込み
                    loadImage('./img/0.png'),
                    loadImage('./img/1.png'),
                    loadImage('./img/2.png'),
                    loadImage('./img/3.png'),
                    loadImage('./img/4.png'),
                ];
                for (let i = 0; i < 1; i++) {
                    playerOriginalImages[i] = loadImage(`./img/player${i}.png`);
                }
            }

            function setup() {
                createCanvas(document.body.clientWidth - 1, document.body.clientHeight - 1);
                imageMode(CENTER);
                for (let i = 0; i < 1; i++) {
                    playerImages[i] = [];
                    const buf = playerOriginalImages[i];
                    const w = buf.width / 4;
                    const h = buf.height / 4;
                    for (let j = 0; j < 4; j++) {
                        playerImages[i][j] = [];
                        for (let k = 0; k < 4; k++) {
                            playerImages[i][j][k] = buf.get(k * w, j * h, w, h);  //１枚の画像を4×4に分割して、配列に格納する
                        }
                    }
                }
            }

            function onConnection() {
                goNextStage(0);
            }

            function onStandAlone() {
                goNextStage(0);
            }

            function draw() {
                background(0);
                let myCoordinate = monoSocket.getPlayerData(myPlayerId, "座標");  // サーバーからデータを受け取る
                if (!myCoordinate) return;
                const nowStage = monoSocket.getRoomData('現在のステージ');
                if (!nowStage) return;
                if (!(0 <= nowStage.number && nowStage.number < mapMatrix.length)) return;
                //
                let tileSize = ((width < height) ? width : height) / 10;
                //
                if (!myCoordinate.direction) {
                    myCoordinate.direction = 0;
                }
                if (keyIsPressed) {
                    const speed = 0.1;
                    if (key === "w" || keyCode === UP_ARROW) {
                        myCoordinate.y -= speed;
                        myCoordinate.direction = 3;
                    }
                    else if (key === "s" || keyCode === DOWN_ARROW) {
                        myCoordinate.y += speed;
                        myCoordinate.direction = 0;
                    }
                    else if (key === "d" || keyCode === RIGHT_ARROW) {
                        myCoordinate.x += speed;
                        myCoordinate.direction = 1;
                    }
                    else if (key === "a" || keyCode === LEFT_ARROW) {
                        myCoordinate.x -= speed;
                        myCoordinate.direction = 2;
                    }
                }
                let x0 = Math.round(myCoordinate.x);
                let x1 = Math.round(myCoordinate.x);
                let x2 = x1;
                if (x1 < myCoordinate.x) {
                    x2 = Math.ceil(myCoordinate.x);
                }
                else if (myCoordinate.x < x1) {
                    x1 = Math.floor(myCoordinate.x);
                }
                let y1 = Math.round(myCoordinate.y);
                let y2 = y1;
                if (y1 < myCoordinate.y) {
                    y2 = Math.ceil(myCoordinate.y);
                }
                else if (myCoordinate.y < y1) {
                    y1 = Math.floor(myCoordinate.y);
                }
                if (
                    getMap(nowStage.number, x1, y1) == 1 ||
                    getMap(nowStage.number, x2, y1) == 1 ||
                    getMap(nowStage.number, x1, y2) == 1 ||
                    getMap(nowStage.number, x2, y2) == 1
                ) {
                    myCoordinate.x = Math.round(myCoordinate.x);
                    myCoordinate.y = Math.round(myCoordinate.y);
                }
                monoSocket.writePlayerData(
                    myPlayerId,
                    '座標',
                    myCoordinate,
                );
                //
                const mapX = (width / 2) - (myCoordinate.x * tileSize);    //画面上における、マップの左上の座標
                const mapY = (height / 2) - (myCoordinate.y * tileSize);    //画面上における、マップの左上の座標
                //
                // マップを描画
                for (let i = 0; i < mapMatrix[nowStage.number].length; i++) {
                    for (let j = 0; j < mapMatrix[nowStage.number][i].length; j++) {
                        const groundType = mapMatrix[nowStage.number][i][j];
                        if (groundType == 1) {
                            fill(0);
                        }
                        else {
                            fill(255);
                        }
                        image(
                            groundImages[groundType],
                            mapX + (j * tileSize),
                            mapY + (i * tileSize),
                            tileSize,
                            tileSize,
                        );
                    }
                }
                //
                // プレイヤーを描画
                const playerIds = monoSocket.getPlayerIds();
                for (let i = 0; i < monoSocket.getPlayerNumber(); i++) {
                    // サーバーからデータを受け取る
                    const coordinate = monoSocket.getPlayerData(playerIds[i], "座標");
                    if (!coordinate) continue;
                    const animeSpeed = 2;
                    const walk = Math.floor(((coordinate.x + coordinate.y) % animeSpeed) / animeSpeed * 4);
                    const img = playerImages[0][coordinate.direction][walk];
                    image(
                        img,
                        mapX + (coordinate.x * tileSize),
                        mapY + (coordinate.y * tileSize),
                        tileSize / img.height * img.width,
                        tileSize,
                    );
                }
                fill(255);
                stroke(255);
                text(`部屋番号：${roomNumber ?? '？'}`, 30, 30);
            }

            function getMap(stageNumber, x, y) {
                if (!(0 <= stageNumber && stageNumber < mapMatrix.length)) {
                    return 1;
                }
                const i = Math.round(y);
                const j = Math.round(x);
                if (0 <= i && i < mapMatrix[stageNumber].length) {
                    if (0 <= j && j < mapMatrix[stageNumber][i].length) {
                        return mapMatrix[stageNumber][i][j];
                    }
                }
                return 1;
            }

            // 新しいステージに挑戦するときの初期化処理
            function goNextStage(newStage) {
                if (!(0 <= newStage && newStage < mapMatrix.length)) {
                    alert('次のステージが存在しません');
                    return;
                }
                console.log('a');
                monoSocket.writeRoomData(
                    '現在のステージ',
                    {
                        number: newStage,
                        startTime: new Date().getTime(),
                    },
                );
                //
                // プレイヤーの初期位置を見つける
                for (let i = 0; i < mapMatrix[newStage].length; i++) {
                    for (let j = 0; j < mapMatrix[newStage][i].length; j++) {
                        if (mapMatrix[newStage][i][j] == 2) {
                            monoSocket.writePlayerData(
                                myPlayerId,
                                '座標',
                                { x: j, y: i, direction: 0 },
                            );
                            return;
                        }
                    }
                }
                alert(`ステージ${newStage}に移行しようとしましたが、プレイヤーの初期位置が見つかりませんでした`);
            }
        </script>
    </body>

</html>
